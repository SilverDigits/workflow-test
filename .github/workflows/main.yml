
name: Build & Sign using AAS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-sign:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Evaluate Release Tag
      id: release_eval
      shell: pwsh
      run: |
        $ref = "${{ github.ref }}"
        $pattern = '^refs/tags/v([0-9]+\.[0-9]+\.[0-9]+)$'
        if ($ref -match $pattern) {
          $version = $Matches[1]
          echo "needs_released=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          echo "release_version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        } else {
          echo "needs_released=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          echo "release_version=" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        }

    - name: Build
      run: >
        dotnet publish ./src/Hoario.Cli/Hoario.Cli.csproj 
        -c Release 
        -r win-x64
        --self-contained true
        /p:PublishSingleFile=true
        /p:DebugType=embedded
        /p:DebugSymbols=true
        -o out

    - name: Add signtool to PATH
      if: steps.release_eval.outputs.needs_released == 'true'
      uses: kamaranl/add-signtool-action@v1 

    - name: Azure Login (OIDC)
      if: steps.release_eval.outputs.needs_released == 'true'
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Sign binaries using AAS
      if: steps.release_eval.outputs.needs_released == 'true'
      uses: azure/artifact-signing-action@v1
      with:
        endpoint: https://eus.codesigning.azure.net/
        signing-account-name: silverdigits-signing
        certificate-profile-name: org-public
        files-folder: out
        files-folder-filter: exe
        exclude-environment-credential: true
        exclude-workload-identity-credential: true
        exclude-managed-identity-credential: true
        exclude-shared-token-cache-credential: true
        exclude-visual-studio-credential: true
        exclude-visual-studio-code-credential: true
        exclude-azure-cli-credential: false
        exclude-azure-powershell-credential: true
        exclude-azure-developer-cli-credential: true
        exclude-interactive-browser-credential: true

    - name: Verify signatures
      if: steps.release_eval.outputs.needs_released == 'true'
      shell: pwsh
      run: |
        $files = Get-ChildItem out -Include *.exe,*.dll -Recurse
        foreach ($f in $files) {
          Write-Host "Verifying $($f.FullName)"
          & "signtool.exe" verify /pa "$($f.FullName)"
        }

    - name: Upload artifact (whole folder)
      uses: actions/upload-artifact@v4
      with:
        name: hoario-win-x64
        path: out/**
        if-no-files-found: error
        retention-days: 14          # optional
        compression-level: 6        # 0-9, optional
        overwrite: true             # optional; replaces if artifact exists